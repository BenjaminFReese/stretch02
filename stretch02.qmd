---
title: "stretch02"
subtitle:"Predicting Civil Servant Exit"
author: "Benjamin Reese"
format: pdf
---

## Setup

```{r packages and data loading}
## Packages
library(tidyverse)
library(tidymodels)
library(lubridate)
library(readr)
library(patchwork)
library(ggjoy)

## Data Loading
sep_data <- read.csv("SEPDATA_FY2005-2009.TXT")
load("~/Fall 2022/Data Science/stretch02/data/fed.RData")
app_data <- read_csv("data/EAD+2.0+quarter+101019.csv")
```

### (a)

#### Why Do Federal Employees Leave the Civil Service?

I am loading and joining three datasets together. The main dataset, that includes the variable I want to predict is `sep_data`. This dataset includes information on nearly every federal employee, covering most non-intelligence community agencies, who left federal service from 2005-2009. The goal of this analysis is to predict when federal employees will quit the federal workforce versus leaving for other reasons. The dependent variable is coded as quit or not quit. The other two datasets are for factors beyond what OPM tracks that mya contribute to people quitting the federal workforce. These datasets include economic variables like inflation and a variable for presidential approval. The end result of the analysis would be a model that predicts when an employee leaves, that they quit. 

The other types of leaving including in the dataset like retirements and Reductions In Force are mostly controllable or easily predicted by agencies based on the age of their employees and their internal staffing decisions. Quitting, though, can seriously disrupt an agencies function and is not as easily controlled by federal managers. Hopefully, this model will give some indication about when employees are likely to quit, and show the important factors that predict quitting. In sum, this model answer the question: why do federal employees leave the civil service?

```{r cleaning and joining, warning=FALSE,message=FALSE}
## Loading in data on when federal employees quit, creating education and quit variables
sep_data <- sep_data %>%
  mutate(quarter = str_replace_all(EFDATE, "(.{4})(.*)", "\\1-\\2"),
         quarter = quarter(ym(quarter), type = "year.quarter"),
         separation = if_else(SEP == "SC", "Quit", "Not Quit"),
         EDLVL = as.numeric(EDLVL)) %>%
  filter(!is.na(EDLVL) & EDLVL != "**")%>%
  mutate(education = case_when(
           EDLVL < 4 ~ "Less Than High School",
           EDLVL == 4 ~ "High School or GED",
           EDLVL == 5 | EDLVL == 6 | EDLVL == 7 | EDLVL == 8 | EDLVL == 9 |
           EDLVL == 10 | EDLVL == 11 | EDLVL == 12 ~ "Less than Bachelors",
           EDLVL == 13 ~ "Bachelors",
           EDLVL > 13 ~ "Graduate")) %>%
  select(separation, education, quarter, SALARY, LOS)

## dropping unused variables, creating a unified presidents and party variable, and filtering to only quarters
## included in the civil servant exit data
econ_data <- dta %>%
  select(-Democrat, -pres1, -pres2, -pres3, -pres4, -pres5, -pres6, -pres7, 
         -pres8, -pres9, -pres10, -pres11, -pres12, -pres13, -pres14, -pres15) %>%
  mutate(admin = case_when(
    president == 1 ~ "Obama",
    president == 2 | president == 3 ~ "Eisenhower",
    president == 4 ~ "H.W. Bush",
    president == 5 | president == 6 ~ "W. Bush",
    president == 7 ~ "Carter",
    president == 8 ~ "Kennedy-Johnson",
    president == 9 ~ "Johnson",
    president == 10 ~ "Nixon-Ford",
    president == 11 ~ "Nixon",
    president == 12 | president == 13 ~ "Reagan",
    president == 14 | president == 15 ~ "Clinton"),
  party = case_when(
    president_party == 2 ~ "R",
    president_party == 1 ~ "D"),
  quarter = quarter(DATE,type = "year.quarter")) %>%
    select(-president, -president_party, -DATE, -ygap)

## filtering to only include the US, dropping unused variables and renaming
app_data <- app_data %>%
  filter(Country == "United States") %>%
  select(qtr, Approval_Smoothed) %>%
  mutate(approval = Approval_Smoothed,
    quarter = as.numeric(str_replace_all(qtr, 'q', "."))) %>%
  select(-Approval_Smoothed, -qtr)

## joining the three datasets all together into one unified tibble
sep <- sep_data %>%
  left_join(econ_data, by="quarter") %>%
  left_join(app_data, by = "quarter") %>%
  janitor::clean_names()

```

### (b)

```{r splitting}
## Setting Seed
set.seed(20201124)

## Splitting the Sample
split <- initial_split(sep, prop = 0.7)

## Training and Testing
sep_train <- training(split)
sep_test <- testing(split)
```

### (c)

```{r exploratory data analysis}
## Displying More Places In Numbers

options(scipen = 999999)
## Exploratory Data Analysis

## Line Plot of the # Employees Quitting
m2 <- sep_train %>%
  filter(separation == "Quit") %>%
  group_by(quarter) %>%
  count(separation=="Quit") %>%
  ggplot(aes(x=quarter, y=n)) +
  geom_line(lwd=1, col="light blue") +
    geom_point(col="blue") +
  theme_minimal() +
  labs(title = "When Civil Servants Exit", 
       subtitle = "Federal Employees Quit Most in Third Quarters",
       x=NULL, y="# Quitting")

## Line Plot of the Percentage of Employees Leaving That Quit
m1 <- sep_train %>%
  mutate(separation = if_else(separation == "Quit", 1, 0)) %>%
  group_by(quarter) %>%
  summarise(percent_quit = mean(separation)) %>%
  mutate(percent_quit=percent_quit*100) %>%
  ggplot(aes(x=quarter, y=percent_quit)) +
  geom_line(lwd=1, col="light blue") +
   geom_point(col="blue") +
  theme_minimal() +
  lims(y=c(33,43))+
  labs(x="Fiscal Year Quarter", y="Percent Exits Who Quit", 
       caption = "Data Source: Office of Personnel Management")
## Using patchwork to display together
m2 / m1

## Relationship Between Salary And Quitting
sep_train %>%
  group_by(separation) %>%
  ggplot(aes(x=salary, y=separation)) +
  geom_violin(scale="area", col="blue", fill="light blue") +
  theme_minimal() +
  coord_flip() +
  labs(y=NULL, x="Salary ($)", 
       title="Distribution of Salary For Those Who Quit Vs Leave For Other Reasons",
       subtitle = "Lower Income Employees More Likely to Quit")

## Relationship Between Presidential Approval And Quitting
sep_train %>%
  group_by(separation) %>%
  ggplot(aes(x=approval, y=separation, fill=separation)) +
  geom_joy() +
  theme_minimal() +
  labs(y=NULL, x="Approval Rating (%)", 
       title="Presidential Approval and Federal Employee Exit",
       subtitle = "More Employees Quit When Presidential Approval Is Low",
       fill=NULL)

## Relationship Between Fed Funds Rate And Quitting
sep_train %>%
  group_by(separation) %>%
  ggplot(aes(x=lag_fedfunds, y=separation, fill=separation)) +
  geom_joy() +
  theme_minimal() +
  labs(y=NULL, x="Lagged Fed Funds Rate", 
       title="Federal Interest Rates and Employee Exit",
       subtitle = "More Employees Leave When Interest Rates Are High",
       fill=NULL)

## Party And Quitting
sep_train %>%
  mutate(separation = if_else(separation == "Quit", 1, 0)) %>%
  group_by(party) %>%
  summarise(percent_quit = mean(separation))
  

```

The data analysis above explores a few possible variables that may be important in predicting when federal employees quit. The first two plots simply plot the number and proportion of quitting employees over the nearly 5 years included in the dataset. 

The violin plot below the line graphs show that the majority of quitters are in low income positions, meaning the people with higher pay, and probably more prestigious or professional careers, are less likely to quit than lower income employees.

Perhaps unexpectedly, federal employees are more likely to quit when presidential approval rating is lower. As the president is the Chief Executive Officer of the federal bureaucracy, it makes sense that a disliked president will see more of their employees leaving than a liked president. It is important to remember that this data mostly only as 1 president: George W. Bush.

The final joyplot uses the Federal Reserve Funds rate as a proxy for economic performance. The Federal Reserve usually increases interest rates to slow economic growth in order to stem inflation and maintain normative location on the Phillip's Curve, times with high Fed Funds rates can be used as an economic indicator. The plot shows that more civil servants quit when Fed Funds rates are high. The full dataset includes variables for inflation, so it will be interesting to see how important economic performance is for predicting federal employee exit.

Finally, the table above shows that Republicans, in this case only George W. Bush, saw a higher percentage of employees leaving as quitters than Obama.

### (d)

Recall/Sensitivy/True Positive rate is most important error metric for this analysis because the goal is to accurately predict an event. Incorrect predictions are the most costly form of error because not preparing for a large sudden civil servant exit could cause large efficiency losses in the federal service. Thus, a false negative is more damaging than a false positive. A false positive, or expecting a federal employee to quit, may still carry large costs if the prediction is so incorrect that it causes agencies to hire unneeded employees, but, overall, with the goal being to reduce uncertainty in the exiting of civil servants, false negatives are far more costly. In sum, the costs of false negatives, and a low sensitivity/recall makes the model useless because it is not fulfilling its role in reducing uncertainty in federal employee exit.

## Models

### (a) 

I define here three candidate models: a CART model, a logistic regression model, and a random forest model. Their exact specifications are below.

The outcome variable to be classified is reason for separation, and it will be down-sampled in one recipe. The predictor variables are: level of education, fiscal quarter, employee salary, the Federal Reserve Funds rate, debt-to-GDP ratio, expenditure-to-GDP ratio, inflation, presidential administration, party of president, and presidential approving rating. Since there are a variety of different units and, for example, the salary and inflation variables are wildly skewed, all of these predictors need normalization during pre-processing. I will also drop variables without much variance, most likely president and president's party will be dropped. I will also turn the character variables into dichotomous predictors. The exact pre-processing for each variable can be found below:


```{r 2 recipes}
sep_rec_1 <-
  recipe(separation ~ ., data = sep_train) %>%
  themis::step_downsample(separation) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_normalize(all_numeric_predictors()) %>%
  step_nzv(all_numeric_predictors())

sep_rec_2 <-
  recipe(separation ~ ., data = sep_train) %>%
  step_normalize(all_numeric_predictors()) %>%
  step_nzv(all_predictors())

```

